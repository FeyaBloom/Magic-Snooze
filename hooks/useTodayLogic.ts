import { useEffect } from 'react';
import { useRoutineManager } from './useRoutineManager';
import { useDailyProgress } from './useDailyProgress';
import { useVictories } from './useVictories';
import { useDailyReset } from './useDailyReset';

export const useTodayLogic = () => {
  const routineManager = useRoutineManager();
  const progressManager = useDailyProgress();
  const victoriesManager = useVictories();

  // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä—É—Ç–∏–Ω
  useEffect(() => {
    if (routineManager.morningRoutine.length > 0 || routineManager.eveningRoutine.length > 0) {
      progressManager.saveProgress(routineManager.morningRoutine, routineManager.eveningRoutine);
    }
  }, [routineManager.morningRoutine, routineManager.eveningRoutine]);

  // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±—Ä–æ—Å –≤ –ø–æ–ª–Ω–æ—á—å
  useDailyReset({
    onResetRoutines: routineManager.resetDailyRoutines,
    onResetProgress: progressManager.resetProgress,
    onResetVictories: victoriesManager.resetVictories,
    onReset: () => {
      // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ
      console.log('üîÑ Daily reset completed');
    },
  });

  // –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è toggleStep —Å –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
  const toggleStep = async (stepId: string, routine: 'morning' | 'evening') => {
    const updatedRoutine = await routineManager.toggleStep(stepId, routine, progressManager.isSnoozed);
    if (updatedRoutine) {
      const otherRoutine = routine === 'morning' ? routineManager.eveningRoutine : routineManager.morningRoutine;
      progressManager.saveProgress(
        routine === 'morning' ? updatedRoutine : otherRoutine,
        routine === 'evening' ? updatedRoutine : otherRoutine
      );
    }
  };

  // –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è addStep —Å –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
  const addStep = async (text: string, routine: 'morning' | 'evening') => {
    const updatedRoutine = await routineManager.addStep(text, routine);
    if (updatedRoutine) {
      const otherRoutine = routine === 'morning' ? routineManager.eveningRoutine : routineManager.morningRoutine;
      progressManager.saveProgress(
        routine === 'morning' ? updatedRoutine : otherRoutine,
        routine === 'evening' ? updatedRoutine : otherRoutine
      );
    }
    return updatedRoutine;
  };

  // –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è editStep —Å –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
  const editStep = async (stepId: string, newText: string, routine: 'morning' | 'evening') => {
    const updatedRoutine = await routineManager.editStep(stepId, newText, routine);
    if (updatedRoutine) {
      const otherRoutine = routine === 'morning' ? routineManager.eveningRoutine : routineManager.morningRoutine;
      progressManager.saveProgress(
        routine === 'morning' ? updatedRoutine : otherRoutine,
        routine === 'evening' ? updatedRoutine : otherRoutine
      );
    }
    return updatedRoutine;
  };

  // –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è deleteStep —Å –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
  const deleteStep = async (stepId: string, routine: 'morning' | 'evening') => {
    const updatedRoutine = await routineManager.deleteStep(stepId, routine);
    if (updatedRoutine) {
      const otherRoutine = routine === 'morning' ? routineManager.eveningRoutine : routineManager.morningRoutine;
      progressManager.saveProgress(
        routine === 'morning' ? updatedRoutine : otherRoutine,
        routine === 'evening' ? updatedRoutine : otherRoutine
      );
    }
    return updatedRoutine;
  };

  // –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è snoozeToday
  const snoozeToday = async () => {
    return await progressManager.snoozeToday(routineManager.morningRoutine, routineManager.eveningRoutine);
  };

  return {
    // –î–∞–Ω–Ω—ã–µ
    morningRoutine: routineManager.morningRoutine,
    eveningRoutine: routineManager.eveningRoutine,
    todayProgress: progressManager.todayProgress,
    isSnoozed: progressManager.isSnoozed,
    celebratedVictories: victoriesManager.celebratedVictories,

    // –ú–µ—Ç–æ–¥—ã –¥–ª—è —Ä—É—Ç–∏–Ω
    toggleStep,
    addStep,
    editStep,
    deleteStep,

    // –ú–µ—Ç–æ–¥—ã –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    snoozeToday,

    // –ú–µ—Ç–æ–¥—ã –¥–ª—è –ø–æ–±–µ–¥
    celebrateVictory: victoriesManager.celebrateVictory,
  };
};