import React, { createContext, useContext, useState, useEffect } from 'react';
import AsyncStorage from '@react-native-async-storage/async-storage';
import i18n from '@/i18n';

export type LanguageCode = 'en' | 'ru' | 'es' | 'fr' | 'de';

export interface Language {
  code: LanguageCode;
  name: string;
  nativeName: string;
  flag: string;
}

export const availableLanguages: Language[] = [
  { code: 'en', name: 'English', nativeName: 'English', flag: 'üá∫üá∏' },
  { code: 'ru', name: 'Russian', nativeName: '–†—É—Å—Å–∫–∏–π', flag: 'üá∑üá∫' },
  { code: 'es', name: 'Spanish', nativeName: 'Espa√±ol', flag: 'üá™üá∏' },
  { code: 'fr', name: 'French', nativeName: 'Fran√ßais', flag: 'üá´üá∑' },
  { code: 'de', name: 'German', nativeName: 'Deutsch', flag: 'üá©üá™' },
];

// –ü–µ—Ä–µ–≤–æ–¥—ã –¥–ª—è –≤—Å–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
const translations: Record<LanguageCode, any> = {
  en: {
    common: {
      cancel: 'Cancel',
      save: 'Save',
      delete: 'Delete',
      edit: 'Edit',
      add: 'Add',
      close: 'Close',
      confirm: 'Confirm',
      yes: 'Yes',
      no: 'No',
    },
    today: {
      title: 'Good day, beautiful soul üå∏',
      subtitle: 'Take it one step at a time',
      subtitleSnoozed: 'You\'re taking a gentle break today',
      snoozeToday: 'Snooze Today',
      resumeToday: 'Resume Today',
      tinyVictories: 'Tiny Victories',
      morningRoutine: 'Morning Routine',
      eveningRoutine: 'Evening Routine',
      todaysProgress: 'Today\'s Progress',
      morning: 'Morning',
      evening: 'Evening',
      addNewStep: 'Add New Step',
      editStep: 'Edit Step',
      enterGentleStep: 'Enter a gentle step...',
      addStep: 'Add Step',
      deleteStep: 'Delete Step',
      deleteStepConfirm: 'Are you sure you want to delete this step?',
      defaultMorning: {
        stretch: 'Gentle stretch or movement',
        breathing: 'Mindful breathing (2 minutes)',
        intention: 'Set one gentle intention for today',
      },
      defaultEvening: {
        reflect: 'Reflect on one positive moment',
        selfCare: 'Gentle self-care activity',  
        prepare: 'Prepare for tomorrow with kindness',
      },
    },
    settings: {
      title: 'Settings & About ‚öôÔ∏è',
      appPreferences: 'App Preferences',
      messyMode: {
        title: 'Messy mode',
        description: 'Shuffle colors of the current theme',
      },
      language: {
        title: 'Language',
        currently: 'Currently',
        selectLanguage: 'Select Language',
      },
      account: 'Account',
      connectGoogle: {
        title: 'Connect Google Account',
        description: 'Sync progress and tasks',
      },
      manageProfile: {
        title: 'Manage Profile',
        description: 'View or edit user details',
      },
      contactSupport: 'Contact & Support',
      contactCreator: {
        title: 'Contact the Creator',
        description: 'Text me',
      },
      supportApp: {
        title: 'Support this app',
        description: 'Send a magical donation üí∞',
      },
    },
  },
  ru: {
    common: {
      cancel: '–û—Ç–º–µ–Ω–∞',
      save: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
      delete: '–£–¥–∞–ª–∏—Ç—å',
      edit: '–ò–∑–º–µ–Ω–∏—Ç—å',
      add: '–î–æ–±–∞–≤–∏—Ç—å',
      close: '–ó–∞–∫—Ä—ã—Ç—å',
      confirm: '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å',
      yes: '–î–∞',
      no: '–ù–µ—Ç',
    },
    today: {
      title: '–î–æ–±—Ä–æ–≥–æ –¥–Ω—è, –ø—Ä–µ–∫—Ä–∞—Å–Ω–∞—è –¥—É—à–∞ üå∏',
      subtitle: '–î–µ–ª–∞–π —à–∞–≥ –∑–∞ —à–∞–≥–æ–º',
      subtitleSnoozed: '–°–µ–≥–æ–¥–Ω—è —Ç—ã –º—è–≥–∫–æ –æ—Ç–¥—ã—Ö–∞–µ—à—å',
      snoozeToday: '–û—Ç–ª–æ–∂–∏—Ç—å –Ω–∞ —Å–µ–≥–æ–¥–Ω—è',
      resumeToday: '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è',
      tinyVictories: '–ú–∞–ª–µ–Ω—å–∫–∏–µ –ø–æ–±–µ–¥—ã',
      morningRoutine: '–£—Ç—Ä–µ–Ω–Ω—è—è —Ä—É—Ç–∏–Ω–∞',
      eveningRoutine: '–í–µ—á–µ—Ä–Ω—è—è —Ä—É—Ç–∏–Ω–∞',
      todaysProgress: '–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–µ–≥–æ–¥–Ω—è',
      morning: '–£—Ç—Ä–æ',
      evening: '–í–µ—á–µ—Ä',
      addNewStep: '–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —à–∞–≥',
      editStep: '–ò–∑–º–µ–Ω–∏—Ç—å —à–∞–≥',
      enterGentleStep: '–í–≤–µ–¥–∏—Ç–µ –º—è–≥–∫–∏–π —à–∞–≥...',
      addStep: '–î–æ–±–∞–≤–∏—Ç—å —à–∞–≥',
      deleteStep: '–£–¥–∞–ª–∏—Ç—å —à–∞–≥',
      deleteStepConfirm: '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —à–∞–≥?',
      defaultMorning: {
        stretch: '–ú—è–≥–∫–∞—è —Ä–∞—Å—Ç—è–∂–∫–∞ –∏–ª–∏ –¥–≤–∏–∂–µ–Ω–∏–µ',
        breathing: '–û—Å–æ–∑–Ω–∞–Ω–Ω–æ–µ –¥—ã—Ö–∞–Ω–∏–µ (2 –º–∏–Ω—É—Ç—ã)',
        intention: '–ü–æ—Å—Ç–∞–≤—å –æ–¥–Ω–æ –º—è–≥–∫–æ–µ –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è',
      },
      defaultEvening: {
        reflect: '–ü–æ–¥—É–º–∞–π –æ–± –æ–¥–Ω–æ–º –ø–æ–∑–∏—Ç–∏–≤–Ω–æ–º –º–æ–º–µ–Ω—Ç–µ',
        selfCare: '–ú—è–≥–∫–∞—è –∑–∞–±–æ—Ç–∞ –æ —Å–µ–±–µ',
        prepare: '–ü–æ–¥–≥–æ—Ç–æ–≤—å—Å—è –∫ –∑–∞–≤—Ç—Ä–∞—à–Ω–µ–º—É –¥–Ω—é —Å –¥–æ–±—Ä–æ—Ç–æ–π',
      },
    },
    settings: {
      title: '–î–µ—Ç–∞–ª–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ‚öôÔ∏è',
      appPreferences: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏',
      messyMode: {
        title: '–•–∞–æ—Ç–∏—á–Ω—ã–π —Ä–µ–∂–∏–º',
        description: '–ü–µ—Ä–µ–º–µ—à–∞—Ç—å —Ü–≤–µ—Ç–∞ —Ç–µ–∫—É—â–µ–π —Ç–µ–º—ã',
      },
      language: {
        title: '–Ø–∑—ã–∫',
        currently: '–¢–µ–∫—É—â–∏–π',
        selectLanguage: '–í—ã–±—Ä–∞—Ç—å —è–∑—ã–∫',
      },
      account: '–ê–∫–∫–∞—É–Ω—Ç',
      connectGoogle: {
        title: '–ü–æ–¥–∫–ª—é—á–∏—Ç—å Google –∞–∫–∫–∞—É–Ω—Ç',
        description: '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ –∑–∞–¥–∞—á–∏',
      },
      manageProfile: {
        title: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª–µ–º',
        description: '–ü—Ä–æ—Å–º–æ—Ç—Ä –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö',
      },
      contactSupport: '–ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞',
      contactCreator: {
        title: '–°–≤—è–∑–∞—Ç—å—Å—è —Å —Å–æ–∑–¥–∞—Ç–µ–ª–µ–º',
        description: '–ù–∞–ø–∏—à–∏—Ç–µ –º–Ω–µ',
      },
      supportApp: {
        title: '–ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ',
        description: '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –º–∞–≥–∏—á–µ—Å–∫–æ–µ –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–µ üí∞',
      },
    },
  },
  es: {
    common: {
      cancel: 'Cancelar',
      save: 'Guardar',
      delete: 'Eliminar',
      edit: 'Editar',
      add: 'A√±adir',
      close: 'Cerrar',
      confirm: 'Confirmar',
      yes: 'S√≠',
      no: 'No',
    },
    today: {
      title: 'Buen d√≠a, alma hermosa üå∏',
      subtitle: 'Ve paso a paso',
      subtitleSnoozed: 'Te est√°s tomando un descanso suave hoy',
      snoozeToday: 'Aplazar hoy',
      resumeToday: 'Reanudar hoy',
      tinyVictories: 'Peque√±as victorias',
      morningRoutine: 'Rutina matutina',
      eveningRoutine: 'Rutina nocturna',
      todaysProgress: 'Progreso de hoy',
      morning: 'Ma√±ana',
      evening: 'Noche',
      addNewStep: 'A√±adir nuevo paso',
      editStep: 'Editar paso',
      enterGentleStep: 'Introduce un paso suave...',
      addStep: 'A√±adir paso',
      deleteStep: 'Eliminar paso',
      deleteStepConfirm: '¬øEst√°s seguro de que quieres eliminar este paso?',
      defaultMorning: {
        stretch: 'Estiramiento suave o movimiento',
        breathing: 'Respiraci√≥n consciente (2 minutos)',
        intention: 'Establece una intenci√≥n suave para hoy',
      },
      defaultEvening: {
        reflect: 'Reflexiona sobre un momento positivo',
        selfCare: 'Actividad suave de autocuidado',
        prepare: 'Prep√°rate para ma√±ana con bondad',
      },
    },
    settings: {
      title: 'Configuraci√≥n y Acerca de ‚öôÔ∏è',
      appPreferences: 'Preferencias de la aplicaci√≥n',
      messyMode: {
        title: 'Modo ca√≥tico',
        description: 'Mezclar colores del tema actual',
      },
      language: {
        title: 'Idioma',
        currently: 'Actual',
        selectLanguage: 'Seleccionar idioma',
      },
      account: 'Cuenta',
      connectGoogle: {
        title: 'Conectar cuenta de Google',
        description: 'Sincronizar progreso y tareas',
      },
      manageProfile: {
        title: 'Gestionar perfil',
        description: 'Ver o editar detalles del usuario',
      },
      contactSupport: 'Contacto y soporte',
      contactCreator: {
        title: 'Contactar al creador',
        description: 'Escr√≠beme',
      },
      supportApp: {
        title: 'Apoyar esta aplicaci√≥n',
        description: 'Enviar una donaci√≥n m√°gica üí∞',
      },
    },
  },
  fr: {
    common: {
      cancel: 'Annuler',
      save: 'Sauvegarder',
      delete: 'Supprimer',
      edit: 'Modifier',
      add: 'Ajouter',
      close: 'Fermer',
      confirm: 'Confirmer',
      yes: 'Oui',
      no: 'Non',
    },
    today: {
      title: 'Bonne journ√©e, belle √¢me üå∏',
      subtitle: 'Prends-le √©tape par √©tape',
      subtitleSnoozed: 'Tu prends une pause douce aujourd\'hui',
      snoozeToday: 'Reporter aujourd\'hui',
      resumeToday: 'Reprendre aujourd\'hui',
      tinyVictories: 'Petites victoires',
      morningRoutine: 'Routine matinale',
      eveningRoutine: 'Routine du soir',
      todaysProgress: 'Progr√®s d\'aujourd\'hui',
      morning: 'Matin',
      evening: 'Soir',
      addNewStep: 'Ajouter une nouvelle √©tape',
      editStep: 'Modifier l\'√©tape',
      enterGentleStep: 'Entrez une √©tape douce...',
      addStep: 'Ajouter l\'√©tape',
      deleteStep: 'Supprimer l\'√©tape',
      deleteStepConfirm: '√ätes-vous s√ªr de vouloir supprimer cette √©tape?',
      defaultMorning: {
        stretch: '√âtirement doux ou mouvement',
        breathing: 'Respiration consciente (2 minutes)',
        intention: 'Fixe une intention douce pour aujourd\'hui',
      },
      defaultEvening: {
        reflect: 'R√©fl√©chis √† un moment positif',
        selfCare: 'Activit√© douce de soin de soi',
        prepare: 'Pr√©pare-toi pour demain avec bienveillance',
      },
    },
    settings: {
      title: 'Param√®tres et √Ä propos ‚öôÔ∏è',
      appPreferences: 'Pr√©f√©rences de l\'application',
      messyMode: {
        title: 'Mode d√©sordonn√©',
        description: 'M√©langer les couleurs du th√®me actuel',
      },
      language: {
        title: 'Langue',
        currently: 'Actuellement',
        selectLanguage: 'S√©lectionner la langue',
      },
      account: 'Compte',
      connectGoogle: {
        title: 'Connecter le compte Google',
        description: 'Synchroniser les progr√®s et les t√¢ches',
      },
      manageProfile: {
        title: 'G√©rer le profil',
        description: 'Voir ou modifier les d√©tails de l\'utilisateur',
      },
      contactSupport: 'Contact et support',
      contactCreator: {
        title: 'Contacter le cr√©ateur',
        description: '√âcrivez-moi',
      },
      supportApp: {
        title: 'Soutenir cette application',
        description: 'Envoyer un don magique üí∞',
      },
    },
  },
  de: {
    common: {
      cancel: 'Abbrechen',
      save: 'Speichern',
      delete: 'L√∂schen',
      edit: 'Bearbeiten',
      add: 'Hinzuf√ºgen',
      close: 'Schlie√üen',
      confirm: 'Best√§tigen',
      yes: 'Ja',
      no: 'Nein',
    },
    today: {
      title: 'Guten Tag, sch√∂ne Seele üå∏',
      subtitle: 'Nimm es Schritt f√ºr Schritt',
      subtitleSnoozed: 'Du machst heute eine sanfte Pause',
      snoozeToday: 'Heute verschieben',
      resumeToday: 'Heute fortsetzen',
      tinyVictories: 'Kleine Siege',
      morningRoutine: 'Morgenroutine',
      eveningRoutine: 'Abendroutine',
      todaysProgress: 'Heutiger Fortschritt',
      morning: 'Morgen',
      evening: 'Abend',
      addNewStep: 'Neuen Schritt hinzuf√ºgen',
      editStep: 'Schritt bearbeiten',
      enterGentleStep: 'Geben Sie einen sanften Schritt ein...',
      addStep: 'Schritt hinzuf√ºgen',
      deleteStep: 'Schritt l√∂schen',
      deleteStepConfirm: 'Sind Sie sicher, dass Sie diesen Schritt l√∂schen m√∂chten?',
      defaultMorning: {
        stretch: 'Sanfte Dehnung oder Bewegung',
        breathing: 'Achtsames Atmen (2 Minuten)',
        intention: 'Setze eine sanfte Absicht f√ºr heute',
      },
      defaultEvening: {
        reflect: 'Denke √ºber einen positiven Moment nach',
        selfCare: 'Sanfte Selbstf√ºrsorge-Aktivit√§t',
        prepare: 'Bereite dich mit G√ºte auf morgen vor',
      },
    },
    settings: {
      title: 'Einstellungen & √úber ‚öôÔ∏è',
      appPreferences: 'App-Einstellungen',
      messyMode: {
        title: 'Chaotischer Modus',
        description: 'Farben des aktuellen Themas mischen',
      },
      language: {
        title: 'Sprache',
        currently: 'Aktuell',
        selectLanguage: 'Sprache ausw√§hlen',
      },
      account: 'Konto',
      connectGoogle: {
        title: 'Google-Konto verbinden',
        description: 'Fortschritt und Aufgaben synchronisieren',
      },
      manageProfile: {
        title: 'Profil verwalten',
        description: 'Benutzerdaten anzeigen oder bearbeiten',
      },
      contactSupport: 'Kontakt & Support',
      contactCreator: {
        title: 'Ersteller kontaktieren',
        description: 'Schreiben Sie mir',
      },
      supportApp: {
        title: 'Diese App unterst√ºtzen',
        description: 'Eine magische Spende senden üí∞',
      },
    },
  },
};

interface LanguageContextType {
  currentLanguage: LanguageCode;
  setLanguage: (language: LanguageCode) => void;
  t: (path: string, params?: Record<string, any>) => string;
  availableLanguages: Language[];
  getCurrentLanguage: () => Language;
}

const LanguageContext = createContext<LanguageContextType | undefined>(undefined);

export const useLanguage = () => {
  const context = useContext(LanguageContext);
  if (!context) {
    throw new Error('useLanguage must be used within a LanguageProvider');
  }
  return context;
};

interface LanguageProviderProps {
  children: React.ReactNode;
}

export const LanguageProvider: React.FC<LanguageProviderProps> = ({ children }) => {
  const [currentLanguage, setCurrentLanguage] = useState<LanguageCode>('en');

  useEffect(() => {
    loadLanguage();
  }, []);

  const loadLanguage = async () => {
    try {
      const savedLanguage = await AsyncStorage.getItem('selectedLanguage');
      if (savedLanguage && availableLanguages.some(lang => lang.code === savedLanguage)) {
        setCurrentLanguage(savedLanguage as LanguageCode);
      }
    } catch (error) {
      console.error('Error loading language:', error);
    }
  };

  const setLanguage = async (language: LanguageCode) => {
    try {
      setCurrentLanguage(language);
      await AsyncStorage.setItem('selectedLanguage', language);
    } catch (error) {
      console.error('Error saving language:', error);
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤ –ø–æ –ø—É—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "today.title" –∏–ª–∏ "common.save")
  const t = (path: string, params?: Record<string, any>): string => {
    const keys = path.split('.');
    let value: any = translations[currentLanguage];
    
    for (const key of keys) {
      if (value && typeof value === 'object' && key in value) {
        value = value[key];
      } else {
        // Fallback to English if translation not found
        value = translations.en;
        for (const fallbackKey of keys) {
          if (value && typeof value === 'object' && fallbackKey in value) {
            value = value[fallbackKey];
          } else {
            return `Missing translation: ${path}`;
          }
        }
        break;
      }
    }
    
    if (typeof value !== 'string') {
      return `Invalid translation path: ${path}`;
    }
    
    // Simple parameter replacement
    if (params) {
      return value.replace(/\{\{(\w+)\}\}/g, (match, key) => {
        return params[key] !== undefined ? String(params[key]) : match;
      });
    }
    
    return value;
  };

  const getCurrentLanguage = (): Language => {
    return availableLanguages.find(lang => lang.code === currentLanguage) || availableLanguages[0];
  };

  return (
    <LanguageContext.Provider
      value={{
        currentLanguage,
        setLanguage,
        t,
        availableLanguages,
        getCurrentLanguage,
      }}
    >
      {children}
    </LanguageContext.Provider>
  );
};